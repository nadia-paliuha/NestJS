<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Усі броні (Адмін)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .booking-card { max-width: 1100px; margin: 50px auto; padding: 30px; background-color: #fff; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    table th, table td { vertical-align: middle; }
    #bookingsError { margin-bottom: 15px; }
  </style>
</head>
<body>

<div class="booking-card">
  <h2 class="text-center mb-4">Усі броні</h2>
  <div class="text-center mb-4">
    <button class="btn btn-danger mt-3 w-25" id="baack" onclick="location.href='/profile.html'">Назад</button>
  </div>
  <div class="mb-3 text-center">
    <label for="statusFilter" class="form-label me-2">Фільтр по статусу:</label>
    <select id="statusFilter" class="form-select d-inline-block w-auto">
      <option value="">Всі</option>
      <option value="PENDING">PENDING</option>
      <option value="CONFIRMED">CONFIRMED</option>
      <option value="COMPLETED">COMPLETED</option>
      <option value="CANCELLED">CANCELLED</option>
    </select>
  </div>

  <div id="bookingsError" class="text-center text-danger"></div>

  <table class="table table-bordered text-center">
    <thead class="table-dark">
      <tr>
        <th>Дата</th>
        <th>Початок</th>
        <th>Кінець</th>
        <th>Стіл</th>
        <th>Місць</th>
        <th>Людей</th>
        <th>Користувач</th>
        <th>Статус</th>
        <th>Підтвердити</th>
      </tr>
    </thead>
    <tbody id="bookings-body">
      <tr><td colspan="8">Завантаження броней...</td></tr>
    </tbody>
  </table>
</div>

<script>
  const bookingsBody = document.getElementById('bookings-body');
  const bookingsError = document.getElementById('bookingsError');
  const statusFilter = document.getElementById('statusFilter');

  async function confirmBooking(bookingId) {
    if (!confirm('Підтвердити цю бронь?')) return;

    try {
      const res = await fetch(`http://localhost:3000/booking/update-status/${bookingId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'CONFIRMED' })
      });

      if (!res.ok) {
      let msg = 'Не вдалося підтвердити бронь';
      try {
          const errData = await res.json();
          msg = errData.message || msg;
      } catch {}
      bookingsError.textContent = msg;
      return;
      }

      await loadAllBookings(); 

    } catch (err) {
      console.error(err);
      bookingsError.textContent = err.message || 'Сервер недоступний';
    }
  }

  async function cancelBooking(bookingId) {
    if (!confirm('Скасувати цю бронь?')) return;

    try {
      const res = await fetch(`http://localhost:3000/booking/update-status/${bookingId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ status: 'CANCELLED' })
      });

      if (!res.ok) {
        const errData = await res.json();
        bookingsError.textContent = errData.message || 'Не вдалося скасувати бронь';
        return;
      }

      await loadAllBookings();
    } catch (err) {
      bookingsError.textContent = err.message || 'Сервер недоступний';
    }
  } 

  async function loadAllBookings() {
    try {
      let url = 'http://localhost:3000/booking/all';
      const status = statusFilter.value;
      if (status) url += `?status=${status}`;

      const res = await fetch(url, { credentials: 'include' });

      if (!res.ok) {
        let errMsg = 'Помилка при завантаженні броней';
        try { 
          const errData = await res.json();
          errMsg = errData.message || errMsg;
        } catch {}
        bookingsError.textContent = errMsg;
        bookingsBody.innerHTML = '<tr><td colspan="8">Помилка завантаження</td></tr>';
        return;
      }

      const bookings = await res.json();
      bookingsError.textContent = '';

      if (!bookings.length) {
        bookingsBody.innerHTML = '<tr><td colspan="8">Броней немає</td></tr>';
        return;
      }

      bookingsBody.innerHTML = '';
      bookings.forEach(b => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${b.date}</td>
          <td>${b.start_time.slice(0, 5)}</td>
          <td>${b.end_time.slice(0, 5)}</td>
          <td>${b.table?.number || '-'}</td>
          <td>${b.table?.num_of_seats || '-'}</td>
          <td>${b.numGuests || '-'}</td>
          <td>${b.user?.username || '-'}</td>
          <td>${b.status || '-'}</td>
          <td>
            ${b.status === 'PENDING' 
                ? `<button class="btn btn-success btn-sm confirm-btn me-1">✔️</button>
                  <button class="btn btn-danger btn-sm cancel-btn">✖️</button>` 
                : '—'}
          </td>
        `;

        if (b.status === 'PENDING') {
          const confirmBtn = row.querySelector('.confirm-btn');
          const cancelBtn = row.querySelector('.cancel-btn');

          confirmBtn.addEventListener('click', () => confirmBooking(b.id));
          cancelBtn.addEventListener('click', () => cancelBooking(b.id));
        }
        bookingsBody.appendChild(row);
      });

    } catch (err) {
      console.error(err);
      bookingsError.textContent = err.message || 'Сервер недоступний';
      bookingsBody.innerHTML = '<tr><td colspan="8">Помилка завантаження</td></tr>';
    }
  }

  statusFilter.addEventListener('change', loadAllBookings);
  loadAllBookings();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
